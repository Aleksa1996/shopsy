services:

  # Default configuration for services in *this* file
  _defaults:
    autowire: true      # Automatically injects dependencies in your services.
    autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
    public: false

  App\Common\Infrastructure\ServerConfiguration:
    arguments:
      $kernelProjectDir: '%kernel.project_dir%'
      $appSecret: '%env(APP_SECRET)%'
      $appHostname: '%env(APP_HOSTNAME)%'
      $appSSLEnabled: '%env(bool:APP_SSL_ENABLED)%'
    public: true

  # Command Bus
  App\Common\Application\Bus\Command\Middleware\HandlerMiddleware:
    tags:
      - { name: 'app.command.middleware', priority: 1 }

  App\Common\Application\Bus\Command\Middleware\TransactionalMiddleware:
    arguments:
      $transactionalSession: '@App\Common\Infrastructure\Application\Command\TransactionalSession'
    tags:
      - { name: 'app.command.middleware', priority: 2 }

  App\Common\Application\Bus\Command\Middleware\LoggingMiddleware:
    tags:
      - { name: 'app.command.middleware', priority: 3 }

  App\Common\Application\Bus\Command\Middleware\ExceptionHandlingMiddleware:
    arguments:
      $exceptionHandler: '@App\Common\Application\Command\CommandExceptionHandler'
    tags:
      - { name: 'app.command.middleware', priority: 4 }

  App\Common\Application\Command\CommandExceptionHandler: ~

  App\Common\Application\Bus\Command\CommandBus:
    arguments:
      - !tagged_iterator app.command.middleware

  # Query Bus
  App\Common\Application\Bus\Query\QueryBus: ~

  # Domain events
  App\Common\Domain\Event\DomainEventPublisher:
    factory: [ 'App\Common\Domain\Event\DomainEventPublisher', 'instance' ]
    public: true

  App\Common\Domain\Event\LoggerEventSubscriber:
    tags: [ 'app.domain.event.subscriber' ]

  # Transactional session
  App\Common\Infrastructure\Application\Command\DoctrineSession:
    arguments:
      $entityManager: '@doctrine.orm.entity_manager'
  App\Common\Infrastructure\Application\Command\TransactionalSession: '@App\Common\Infrastructure\Application\Command\DoctrineSession'

  # Param Converter
  App\Common\Infrastructure\Delivery\Symfony\ParamConverter\:
    resource: '%kernel.project_dir%/src/Common/Infrastructure/Delivery/Symfony/ParamConverter'
    tags: [ 'request.param_converter' ]

  # Serializer
  App\Common\Infrastructure\Delivery\Symfony\Serializer\Api\JsonApiDtoNormalizer:
    arguments:
      $serverConfiguration: '@App\Common\Infrastructure\ServerConfiguration'
      $objectNormalizer: '@serializer.normalizer.object'
    tags:
      - {name: 'serializer.normalizer', priority: 20}

  App\Common\Infrastructure\Delivery\Symfony\Serializer\Api\JsonApiNormalizer:
    arguments:
      $serverConfiguration: '@App\Common\Infrastructure\ServerConfiguration'
      $jsonApiDtoNormalizer: '@App\Common\Infrastructure\Delivery\Symfony\Serializer\Api\JsonApiDtoNormalizer'
    tags:
      - {name: 'serializer.normalizer', priority: 21}

  App\Common\Infrastructure\Delivery\Symfony\Serializer\Api\JsonApiErrorNormalizer:
    tags: [ 'serializer.normalizer' ]